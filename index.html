<!doctype html>
<head>
  <meta charset="utf-8">
  <meta keyword="小猪代码">
  <title>小猪代码</title>
  <script src=https://pig-cmd.github.io/bmobSDK.js></script>
  <script>
    onload = function () {
      var username = sessionStorage.getItem("username");
      var uuid = sessionStorage.getItem("uuid");
      if ((username == null || username == "") && (uuid != null && uuid != ""))
        login();
      if ((username != null && username != "") && (uuid == null || uuid == ""))
        login();
      if (username == null && uuid == null)
      {
        document.getElementById("top-box").innerHTML = "小猪代码 <input type=button value=登录 onclick=javascript:login();> <input type=button value=注册 onclick=javascript:register();>";
      }
      else
      {
        document.getElementById("top-box").innerHTML = "小猪代码 <input type=button value=计算机硬件知识 onclick=javascript:knowladge#hard><input type=button value=操作系统知识 onclick=javascript:knowladge#os><input type=button value=编程语言知识 onclick=javascript:knowladge#program><input type=button value=退出登录 onclick=javascript:logout();>";
        document.getElementById("mainbox").innerHTML = "";
      }
    };
    Bmob.initialize("9a7dbe424a6dd457","081126");
  </script>
  <script>
    function login()
    {
      document.getElementById("loginbox").innerHTML = "<table border=10><tr><td><span style='font-size:2em'>登录</span><br>用户名<input type=text maxlength=24 id=username><br>密码<input type=password maxlength=16 id=password><br><a onclick=javascript:register();>没有账户？点我注册</a><br><div id=login-status></div><br><span style='background:#00ff00;color:white;font-size:1.5em;position:absolute;top:90%;right:0%' onclick=javascript:submit_form_login();>登录</span><span style='background:red;color:white;font-size:1.5em;position:absolute;bottom:90%;right:0%' onclick=javascript:close_box_login();>X</span></td></tr></table>";
      document.getElementById("loginbox").className = "show-element";
    }
    function close_box_login()
    {
      document.getElementById("loginbox").className = "hide-element";
    }
    function register()
    {
      document.getElementById("loginbox").innerHTML = "<table border=10><tr><td><span style='font-size:2em'>注册</span><br>用户名<input type=text maxlength=24 id=username><br>密码<input type=password maxlength=16 id=password><br>验证密码<input type=password maxlength=16 id=password2><br><a onclick=javascript:login();>登录</a><br><div id=login-status></div><br><span style='background:#00ff00;color:white;font-size:1.5em;position:absolute;top:90%;right:0%' onclick=javascript:submit_form_register();>注册</span><span style='background:red;color:white;font-size:1.5em;position:absolute;bottom:90%;right:0%' onclick=javascript:close_box_login();>X</span></td></tr></table>";
      document.getElementById("loginbox").className = "show-element";
    }
    function submit_form_login()
    {
      var username = document.getElementById("username").value;
      var password = document.getElementById("password").value;
      Bmob.User.login(username,password).then(res => {
        console.log(res);
        sessionStorage.setItem("username",username);
        sessionStorage.setItem("uuid",res.result.uuid);
        var i = 0;
        setInterval(function(){
          document.getElementById("login-status").innerHTML = "<font color=#00ff00>登录成功！将在" + (10 - i) + "秒后刷新</font>";
          i++;
          if (i > 10)
            location.reload();
        },1000);
      }).catch(err => {
              console.log(err);
              if (err.code == 101)
                document.getElementById("login-status").innerHTML = "<font color=red>登录失败！用户名或密码错误</font>";
        });
    }
    function submit_form_register()
    {
      var username = document.getElementById("username").value;
      var password = document.getElementById("password").value;
      var p2 = document.getElementById("password2").value;
      if (p2 != password)
      {
        document.getElementById("login-status").innerHTML = "<font color=red>注册失败！密码与验证密码不符</font>";
        return;
      }
      if (username.length < 8 || password.length < 8 || username.length > 24 || password.length > 16)
      {
        document.getElementById("login-status").innerHTML = "<font color=red>注册失败！用户名或密码过短或过长<br>用户名长度应该为8~24字<br>密码长度应该为8~16位</font>";
        return;
      }
      var email = Math.random().toString().substring(3) + "@smtp.pig.org";
      var phone = parseInt(Math.random().toString().substring(3,14));
      let userinfo = {"username":username,"password":password,"phone":phone,"email":email};
      var q = Bmob.Query("userinfo");
      q.set("username",username);
      q.set("password",password);
      q.save().then(res=> {
        var r1 = res;
        console.log(res);
        Bmob.User.register(userinfo).then(res => {
          console.log(res);
          sessionStorage.setItem("username",username);
          sessionStorage.setItem("uuid",r1.objectId);
         var i = 0;
         setInterval(function(){
            document.getElementById("login-status").innerHTML = "<font color=#00ff00>注册成功！将在" + (10 - i) + "秒后刷新</font>";
            i++;
            if (i > 10)
             location.reload();
          },1000);
        }).catch(err => {
               console.log(err);
               if (err.code == 400 || err.code == 203)
                  submit_form_register();
                if (err.code == 202)
                  document.getElementById("login-status").innerHTML = "<font color=red>注册失败！用户名重复！</font>";
                 
         });
     }).catch(err => {
        console.log(err);
        submit_form_register();
      });
    }
    
  
  </script>
  <style>
    .hide-element
    {
      display:none;
    }
  </style>
</head>
<body>
  <center>
  <span style='color:white;background:black;text-ailgn:center' id=top-box></span>
    <br>
  <span style='font-size:3em;text-ailgn:center;'>小猪代码</span>
  <div id=mainbox>
    <span style='font-size:2em;color:red'>在您开始学习前，我们建议您先注册/登录<br><input type=button value=注册 onclick=javascript:register();><br><input type=button value=登录 onclick=javascript:login();></span>
  </div>
    <div id=loginbox class=hide-element style='position:fixed;top:20%;left:40%;color:black;background:white'></div>
  </center>
</body>
